<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام حضور بسيط - صفحة واحدة</title>

  <style>
    body{font-family: Tahoma, Arial; padding:18px; background:#f7f7f9}
    .card{background:#fff;border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h1{font-size:20px;margin:0 0 12px}

    input[type=file]{display:block;margin-bottom:12px}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border:1px solid #e6e6e6;text-align:right}
    th{background:#fafafa;font-weight:bold}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0b5ed7;color:#fff;cursor:pointer}
    button.secondary{background:#6c757d}

    .stats{margin-top:12px}
    .small{font-size:13px;color:#666}

    /* تثبيت الجدول */
    #tableWrap{
      max-height:400px;
      overflow:auto;
      margin-top:12px;
      position:relative;
    }

    /* تثبيت صف العناوين */
    #mainTable thead th{
      position:sticky;
      top:0;
      background:#fafafa;
      z-index:10;
    }

    /* تثبيت أول عمود */
    #mainTable td:first-child,
    #mainTable th:first-child {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 9;
    }

    #mainTable thead th:first-child {
      z-index: 11;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>نظام حضور بسيط (صفحة واحدة)</h1>
    <p class="small">ارفع ملف Excel وسيظهر كشف الحضور ويمكنك البحث ووضع علامة الحضور.</p>

    <input id="file" type="file" accept=".xlsx,.xls" />

    <div class="search">
      <input id="filterInput" placeholder="ابحث باسم أو رقم عضوية ..." 
             style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px" />
      <input id="committeeInput" placeholder="ابحث برقم اللجنة ..." 
             style="width:100%;padding:8px;border-radius:6px;border:1px solid:#ddd" />
    </div>

    <div class="controls">
      <button id="markAll">وضع علامة للجميع</button>
      <button id="clearAll" class="secondary">مسح العلامات</button>
      <button id="count" class="secondary">احسب الحضور</button>
      <button id="export" class="secondary">تصدير Excel</button>
      <button id="reset" class="secondary">تفريغ الجدول</button>
    </div>

    <div class="stats">
      <label>عدد الحضور:</label>
      <input type="text" id="autoCount" value="0" readonly 
             style="width:60px;text-align:center;margin-left:8px;"/>
    </div>

    <div id="tableWrap"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const fileInput = document.getElementById('file');
    const tableWrap = document.getElementById('tableWrap');
    const stats = document.getElementById('autoCount'); 
    const filterInput = document.getElementById('filterInput');
    const committeeInput = document.getElementById('committeeInput');

    let rows = [];
    let columns = [];

    function renderTable(displayRows = rows){
      if(displayRows.length===0){ 
        tableWrap.innerHTML = '<p class="small">لا توجد بيانات للعرض.</p>'; 
        return; 
      }

      let html = '<table id="mainTable"><thead><tr>';
      html += '<th>حضور</th>';
      columns.forEach(c=> html += '<th>'+escapeHtml(c)+'</th>');
      html += '</tr></thead><tbody>';

      displayRows.forEach((r,i)=>{
        html += '<tr data-index="'+i+'">';
        html += '<td style="text-align:center"><input class="chk" data-i="'+i+'" type="checkbox" '+(r.__present?'checked':'')+'></td>';
        columns.forEach(c=> html += '<td>'+escapeHtml(String(r[c]??''))+'</td>');
        html += '</tr>';
      });

      html += '</tbody></table>';
      tableWrap.innerHTML = html;

      document.querySelectorAll('.chk').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          const displayed = getFilteredRows();
          const actual = displayed[cb.dataset.i];
          if(actual) actual.__present = cb.checked;
          updateStats(); 
        });
      });
    }

    function escapeHtml(s){ 
      return s.replaceAll('&','&amp;')
              .replaceAll('<','&lt;')
              .replaceAll('>','&gt;');
    }

    function getFilteredRows() {
      const q = filterInput.value.trim().toLowerCase();
      const committee = committeeInput.value.trim();

      return rows.filter(r => {
        let matchGeneral = true;
        let matchCommittee = true;

        if(q){
          matchGeneral = columns.some(c => String(r[c] ?? '').toLowerCase().includes(q));
        }

        if(committee){
          matchCommittee = columns.some(c => c.includes("لجنة") && String(r[c] ?? '').includes(committee));
        }

        return matchGeneral && matchCommittee;
      });
    }

    filterInput.addEventListener('input', ()=> renderTable(getFilteredRows()));
    committeeInput.addEventListener('input', ()=> renderTable(getFilteredRows()));

    fileInput.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0];
      if(!f) return;

      const data = await f.arrayBuffer();
      const wb = XLSX.read(data);
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, {defval: ''});

      if(json.length===0){
        tableWrap.innerHTML = '<p class="small">الملف فارغ.</p>';
        return;
      }

      // استخراج الأعمدة
      columns = Object.keys(json[0]);

      // حذف الأعمدة الفارغة بالكامل
      columns = columns.filter(col => {
        return json.some(row => String(row[col]).trim() !== "");
      });

      // تجهيز الصفوف بدون الأعمدة الفارغة
      rows = json.map(r=> {
        const obj = { __present:false };
        columns.forEach(c => obj[c] = r[c]);
        return obj;
      });

      renderTable(rows);
      updateStats();
    });

    // وضع علامة للجميع
    document.getElementById('markAll').addEventListener('click', ()=>{
      rows.forEach(r=> r.__present=true);
      renderTable(getFilteredRows());
      updateStats();
    });

    // مسح العلامات (برقم سرّي 123)
    document.getElementById('clearAll').addEventListener('click', ()=>{
      const pass = prompt("من فضلك أدخل الرقم السري لمسح العلامات:");
      if(pass !== "123"){ alert("الرقم السري غير صحيح"); return; }

      rows.forEach(r=> r.__present=false);
      renderTable(getFilteredRows());
      updateStats();
      alert("تم مسح العلامات");
    });

    document.getElementById('count').addEventListener('click', updateStats);

    // تفريغ الجدول (بالرقم السري 123)
    document.getElementById('reset').addEventListener('click', ()=>{
      const pass = prompt("من فضلك أدخل الرقم السري لتفريغ الجدول:");
      if(pass === "123"){
          rows=[]; 
          columns=[]; 
          tableWrap.innerHTML=''; 
          stats.value='0'; 
          fileInput.value='';
          alert("تم التفريغ بنجاح");
      } else {
          alert("الرقم السري غير صحيح");
      }
    });

    function updateStats(){
      const present = rows.filter(r=> r.__present).length;
      stats.value = present; 
    }

    // وضع علامة عند الضغط على الصف
    tableWrap.addEventListener('click', (ev)=>{
      const tr = ev.target.closest('tr');
      if(!tr) return;
      const chk = tr.querySelector('.chk');
      if(!chk) return;
      if(ev.target.tagName.toLowerCase() === 'input') return;
      chk.checked = !chk.checked;
      chk.dispatchEvent(new Event('change'));
    });

    // تصدير Excel
    document.getElementById('export').addEventListener('click', ()=>{
      if(rows.length===0){ alert('لا توجد بيانات'); return; }

      const exportData = rows.map(r=>{
        const obj = {...r};
        obj["حضور"] = r.__present ? 'نعم' : 'لا';
        return obj;
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "الحضور");
      XLSX.writeFile(wb, "attendance.xlsx");
    });
  </script>
</body>
</html>
